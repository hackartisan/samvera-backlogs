Derivatives are being lost on bulk ingest
Reported by   has a log of what's going on. A summary is below: So what's going on: CreateDerivativesJob is running derivatives. The PROCESS of running derivatives seems to be running a CheckFixityJob. The CreateDerivativesJob keeps working, holding onto a row lock for the FileSet until it's done. Meanwhile, CheckFixityJob runs. It pulls in the file, runs fixity, and fires an update - which WAITS (nicely! Thanks postgres!) for the lock in CreateDerivativesJob to be released. That finally happens ("finally", it's like, a second time-span) and that update goes through, but that update doesn't have information about the derivative, because it pulled it before CreateDerivativesJob committed its transaction. Tl;dr, optimistic locking retries would have fixed this. So we can fix this by turning on optimistic locking or stopping CreateDerivativesJob from running CheckFixityJob twice.