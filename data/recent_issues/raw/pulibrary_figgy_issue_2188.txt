Derivatives are being lost on bulk ingest
Reported by @roelmoon https://app.datadoghq.com/logs?cols=%5B%22core_host%22%2C%22core_service%22%5D&event&from_ts=1541791469524&index=main&live=true&query=40b6f4df-4c14-4d7d-a7b3-4a2f937a7749&stream_sort=asc&to_ts=1542396269524 has a log of what's going on. A summary is below: So what's going on: CreateDerivativesJob is running derivatives. The PROCESS of running derivatives seems to be running a CheckFixityJob. The CreateDerivativesJob keeps working, holding onto a row lock for the FileSet until it's done. Meanwhile, CheckFixityJob runs. It pulls in the file, runs fixity, and fires an update - which WAITS (nicely! Thanks postgres!) for the lock in CreateDerivativesJob to be released. That finally happens ("finally", it's like, a second time-span) and that update goes through, but that update doesn't have information about the derivative, because it pulled it before CreateDerivativesJob committed its transaction. Tl;dr, optimistic locking retries would have fixed this. So we can fix this by turning on optimistic locking or stopping CreateDerivativesJob from running CheckFixityJob twice.