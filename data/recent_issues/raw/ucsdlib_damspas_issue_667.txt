VRR: Errors in processing AEON revoke queue
Descriptive summary @mdpeters reported that the staging AEON revoke queue is not expiring/revoking users. Looking at the logs, there appears to be an error while processing the users to revoke: Note: the no method for email errors, this is likely our issue. From root@lib-hydrahead-staging.ucsd.edu  Mon Jul  1 01:00:05 2019 Return-Path: <root@lib-hydrahead-staging.ucsd.edu> X-Original-To: conan Delivered-To: conan@lib-hydrahead-staging.ucsd.edu Received: by lib-hydrahead-staging.ucsd.edu (Postfix, from userid 503)         id 34A6D42D30; Mon,  1 Jul 2019 01:00:05 -0700 (PDT) From: root@lib-hydrahead-staging.ucsd.edu (Cron Daemon) To: conan@lib-hydrahead-staging.ucsd.edu Subject: Cron <conan@lib-hydrahead-staging> /bin/bash -l -c 'cd /pub/capistrano/releases/20190628203517 && RAILS_ENV=staging bundle exec rake aeon_requests:revoke_old --silent' Content-Type: text/plain; charset=UTF-8 Auto-Submitted: auto-generated X-Cron-Env: <LANG=en_US.UTF-8> X-Cron-Env: <RAILS_RELATIVE_URL_ROOT=/dc> X-Cron-Env: <SHELL=/bin/sh> X-Cron-Env: <HOME=/home/conan> X-Cron-Env: <PATH=/usr/bin:/bin> X-Cron-Env: <LOGNAME=conan> X-Cron-Env: <USER=conan> Message-Id: <20190701080005.34A6D42D30@lib-hydrahead-staging.ucsd.edu> Date: Mon,  1 Jul 2019 01:00:05 -0700 (PDT)    ESC[1mESC[36mWorkAuthorization Load (0.8ms)ESC[0m  ESC[1mSELECT "work_authorizations".* FROM "work_authorizations" WHERE (updated_at < '2019-06-01 08:00:05.031216')ESC[0m   ESC[1mESC[35mUser Load (0.6ms)ESC[0m  SELECT  "users".* FROM "users" WHERE "users"."id" = $1 LIMIT 1  [["id", 187]] Revoke on 56 failed undefined method `email' for #<Hash:0x000055feebd69c38> /pub/capistrano/releases/20190628203517/lib/processors/new_rights_processor.rb:44:in `initialize' /pub/capistrano/releases/20190628203517/lib/processors/new_rights_processor.rb:27:in `new' /pub/capistrano/releases/20190628203517/lib/processors/new_rights_processor.rb:27:in `block in revoke_old' /pub/capistrano/shared/bundle/ruby/2.3.0/gems/activerecord-4.2.11.1/lib/active_record/relation/delegation.rb:46:in `each' /pub/capistrano/shared/bundle/ruby/2.3.0/gems/activerecord-4.2.11.1/lib/active_record/relation/delegation.rb:46:in `each' /pub/capistrano/releases/20190628203517/lib/processors/new_rights_processor.rb:24:in `revoke_old' /pub/capistrano/releases/20190628203517/lib/tasks/aeon_requests.rake:10:in `block (2 levels) in <top (required)>' /pub/capistrano/shared/bundle/ruby/2.3.0/gems/rake-12.3.1/lib/rake/task.rb:271:in `block in execute' /pub/capistrano/shared/bundle/ruby/2.3.0/gems/rake-12.3.1/lib/rake/task.rb:271:in `each' /pub/capistrano/shared/bundle/ruby/2.3.0/gems/rake-12.3.1/lib/rake/task.rb:271:in `execute' /pub/capistrano/shared/bundle/ruby/2.3.0/gems/rake-12.3.1/lib/rake/task.rb:213:in `block in invoke_with_call_chain' /home/conan/.rbenv/versions/2.3.7/lib/ruby/2.3.0/monitor.rb:214:in `mon_synchronize' /pub/capistrano/shared/bundle/ruby/2.3.0/gems/rake-12.3.1/lib/rake/task.rb:193:in `invoke_with_call_chain' /pub/capistrano/shared/bundle/ruby/2.3.0/gems/rake-12.3.1/lib/rake/task.rb:182:in `invoke' /pub/capistrano/shared/bundle/ruby/2.3.0/gems/rake-12.3.1/lib/rake/application.rb:160:in `invoke_task' /pub/capistrano/shared/bundle/ruby/2.3.0/gems/rake-12.3.1/lib/rake/application.rb:116:in `block (2 levels) in top_level' /pub/capistrano/shared/bundle/ruby/2.3.0/gems/rake-12.3.1/lib/rake/application.rb:116:in `each' /pub/capistrano/shared/bundle/ruby/2.3.0/gems/rake-12.3.1/lib/rake/application.rb:116:in `block in top_level' /pub/capistrano/shared/bundle/ruby/2.3.0/gems/rake-12.3.1/lib/rake/application.rb:125:in `run_with_threads' /pub/capistrano/shared/bundle/ruby/2.3.0/gems/rake-12.3.1/lib/rake/application.rb:110:in `top_level' /pub/capistrano/shared/bundle/ruby/2.3.0/gems/rake-12.3.1/lib/rake/application.rb:83:in `block in run' /pub/capistrano/shared/bundle/ruby/2.3.0/gems/rake-12.3.1/lib/rake/application.rb:186:in `standard_exception_handling' /pub/capistrano/shared/bundle/ruby/2.3.0/gems/rake-12.3.1/lib/rake/application.rb:80:in `run' /pub/capistrano/shared/bundle/ruby/2.3.0/gems/rake-12.3.1/exe/rake:27:in `<top (required)>' /pub/capistrano/shared/bundle/ruby/2.3.0/bin/rake:22:in `load' /pub/capistrano/shared/bundle/ruby/2.3.0/bin/rake:22:in `<top (required)>'  Rationale Provide the rationale or user story that describes "why" this issue should be addressed. Especially if this is a new feature or significant change to the existing implementation. Expected behavior Actual behavior Steps to reproduce the behavior  Do this Then do this...  Related work Link to related tickets or prior related work here.