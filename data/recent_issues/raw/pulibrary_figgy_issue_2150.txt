Full reindex failing on production
There have been several challenges here, most recently a memory problem resolved by #2146 which has successfully run on staging. Now we're seeing an undefined method on ModelConverter::Property NoMethodError: undefined method `apply_to' for #<Valkyrie::Persistence::Solr::ModelConverter::Property:0x00000000051f4e38> /opt/figgy/shared/bundle/ruby/2.4.0/gems/valkyrie-1.2.2/lib/valkyrie/persistence/solr/model_converter.rb:188:in `block in apply_to' /opt/figgy/shared/bundle/ruby/2.4.0/gems/valkyrie-1.2.2/lib/valkyrie/persistence/solr/model_converter.rb:187:in `each' /opt/figgy/shared/bundle/ruby/2.4.0/gems/valkyrie-1.2.2/lib/valkyrie/persistence/solr/model_converter.rb:187:in `apply_to' /opt/figgy/shared/bundle/ruby/2.4.0/gems/valkyrie-1.2.2/lib/valkyrie/persistence/solr/model_converter.rb:113:in `block in attribute_hash' /opt/figgy/shared/bundle/ruby/2.4.0/gems/valkyrie-1.2.2/lib/valkyrie/persistence/solr/model_converter.rb:105:in `each' /opt/figgy/shared/bundle/ruby/2.4.0/gems/valkyrie-1.2.2/lib/valkyrie/persistence/solr/model_converter.rb:105:in `each_with_object' /opt/figgy/shared/bundle/ruby/2.4.0/gems/valkyrie-1.2.2/lib/valkyrie/persistence/solr/model_converter.rb:105:in `attribute_hash' /opt/figgy/shared/bundle/ruby/2.4.0/gems/valkyrie-1.2.2/lib/valkyrie/persistence/solr/model_converter.rb:54:in `to_h' /opt/figgy/shared/bundle/ruby/2.4.0/gems/valkyrie-1.2.2/lib/valkyrie/persistence/solr/model_converter.rb:21:in `convert!' /opt/figgy/shared/bundle/ruby/2.4.0/gems/valkyrie-1.2.2/lib/valkyrie/persistence/solr/resource_factory.rb:28:in `from_resource' /opt/figgy/shared/bundle/ruby/2.4.0/gems/valkyrie-1.2.2/lib/valkyrie/persistence/solr/repository.rb:59:in `solr_document' /opt/figgy/shared/bundle/ruby/2.4.0/gems/valkyrie-1.2.2/lib/valkyrie/persistence/solr/repository.rb:24:in `block in persist' /opt/figgy/shared/bundle/ruby/2.4.0/gems/valkyrie-1.2.2/lib/valkyrie/persistence/solr/repository.rb:22:in `map' /opt/figgy/shared/bundle/ruby/2.4.0/gems/valkyrie-1.2.2/lib/valkyrie/persistence/solr/repository.rb:22:in `persist' /opt/figgy/shared/bundle/ruby/2.4.0/gems/valkyrie-1.2.2/lib/valkyrie/persistence/solr/persister.rb:35:in `save_all' /opt/figgy/releases/20181112195325/app/adapters/instrumented_adapter.rb:94:in `block in save_all' /opt/figgy/releases/20181112195325/app/adapters/instrumented_adapter.rb:48:in `block in trace' /opt/figgy/shared/bundle/ruby/2.4.0/gems/ddtrace-0.16.0/lib/ddtrace/tracer.rb:296:in `trace' /opt/figgy/releases/20181112195325/app/adapters/instrumented_adapter.rb:44:in `trace' /opt/figgy/releases/20181112195325/app/adapters/instrumented_adapter.rb:93:in `save_all' /opt/figgy/releases/20181112195325/app/services/reindexer.rb:30:in `block in reindex_all' /opt/figgy/shared/bundle/ruby/2.4.0/gems/sequel-5.13.0/lib/sequel/dataset/actions.rb:151:in `yield' /opt/figgy/shared/bundle/ruby/2.4.0/gems/sequel-5.13.0/lib/sequel/dataset/actions.rb:151:in `block in each' /opt/figgy/shared/bundle/ruby/2.4.0/gems/sequel-5.13.0/lib/sequel/adapters/postgres.rb:609:in `block in fetch_rows' /opt/figgy/shared/bundle/ruby/2.4.0/gems/sequel-5.13.0/lib/sequel/adapters/postgres.rb:734:in `block (3 levels) in cursor_fetch_rows' /opt/figgy/shared/bundle/ruby/2.4.0/gems/sequel-5.13.0/lib/sequel/adapters/postgres.rb:734:in `yield_hash_rows' /opt/figgy/shared/bundle/ruby/2.4.0/gems/sequel-5.13.0/lib/sequel/adapters/postgres.rb:734:in `block (2 levels) in cursor_fetch_rows' /opt/figgy/shared/bundle/ruby/2.4.0/gems/sequel-5.13.0/lib/sequel/adapters/postgres.rb:142:in `execute' /opt/figgy/shared/bundle/ruby/2.4.0/gems/sequel-5.13.0/lib/sequel/adapters/postgres.rb:496:in `_execute' /opt/figgy/shared/bundle/ruby/2.4.0/gems/sequel_pg-1.11.0/lib/sequel/extensions/pg_streaming.rb:47:in `_execute' /opt/figgy/shared/bundle/ruby/2.4.0/gems/sequel-5.13.0/lib/sequel/adapters/postgres.rb:314:in `block (2 levels) in execute' /opt/figgy/shared/bundle/ruby/2.4.0/gems/sequel-5.13.0/lib/sequel/adapters/postgres.rb:518:in `check_database_errors' /opt/figgy/shared/bundle/ruby/2.4.0/gems/sequel-5.13.0/lib/sequel/adapters/postgres.rb:314:in `block in execute' /opt/figgy/shared/bundle/ruby/2.4.0/gems/sequel-5.13.0/lib/sequel/database/connecting.rb:253:in `block in synchronize' /opt/figgy/shared/bundle/ruby/2.4.0/gems/sequel-5.13.0/lib/sequel/connection_pool/threaded.rb:87:in `hold' /opt/figgy/shared/bundle/ruby/2.4.0/gems/sequel-5.13.0/lib/sequel/database/connecting.rb:253:in `synchronize' /opt/figgy/shared/bundle/ruby/2.4.0/gems/sequel-5.13.0/lib/sequel/adapters/postgres.rb:314:in `execute' /opt/figgy/shared/bundle/ruby/2.4.0/gems/sequel-5.13.0/lib/sequel/dataset/actions.rb:1083:in `execute' /opt/figgy/shared/bundle/ruby/2.4.0/gems/ddtrace-0.16.0/lib/ddtrace/contrib/sequel/dataset.rb:17:in `block in execute' /opt/figgy/shared/bundle/ruby/2.4.0/gems/ddtrace-0.16.0/lib/ddtrace/contrib/sequel/dataset.rb:47:in `block in trace_execute' /opt/figgy/shared/bundle/ruby/2.4.0/gems/ddtrace-0.16.0/lib/ddtrace/tracer.rb:296:in `trace' /opt/figgy/shared/bundle/ruby/2.4.0/gems/ddtrace-0.16.0/lib/ddtrace/contrib/sequel/dataset.rb:42:in `trace_execute' /opt/figgy/shared/bundle/ruby/2.4.0/gems/ddtrace-0.16.0/lib/ddtrace/contrib/sequel/dataset.rb:17:in `execute' /opt/figgy/shared/bundle/ruby/2.4.0/gems/sequel-5.13.0/lib/sequel/adapters/postgres.rb:732:in `block in cursor_fetch_rows' /opt/figgy/shared/bundle/ruby/2.4.0/gems/sequel-5.13.0/lib/sequel/database/transactions.rb:204:in `_transaction' /opt/figgy/shared/bundle/ruby/2.4.0/gems/sequel-5.13.0/lib/sequel/database/transactions.rb:179:in `block in transaction' /opt/figgy/shared/bundle/ruby/2.4.0/gems/sequel-5.13.0/lib/sequel/database/connecting.rb:253:in `block in synchronize' /opt/figgy/shared/bundle/ruby/2.4.0/gems/sequel-5.13.0/lib/sequel/connection_pool/threaded.rb:91:in `hold' /opt/figgy/shared/bundle/ruby/2.4.0/gems/sequel-5.13.0/lib/sequel/database/connecting.rb:253:in `synchronize' /opt/figgy/shared/bundle/ruby/2.4.0/gems/sequel-5.13.0/lib/sequel/database/transactions.rb:145:in `transaction' /opt/figgy/shared/bundle/ruby/2.4.0/gems/sequel-5.13.0/lib/sequel/adapters/postgres.rb:725:in `public_send' /opt/figgy/shared/bundle/ruby/2.4.0/gems/sequel-5.13.0/lib/sequel/adapters/postgres.rb:725:in `cursor_fetch_rows' /opt/figgy/shared/bundle/ruby/2.4.0/gems/sequel-5.13.0/lib/sequel/adapters/postgres.rb:609:in `fetch_rows' /opt/figgy/shared/bundle/ruby/2.4.0/gems/sequel_pg-1.11.0/lib/sequel/extensions/pg_streaming.rb:116:in `fetch_rows' /opt/figgy/shared/bundle/ruby/2.4.0/gems/sequel-5.13.0/lib/sequel/dataset/actions.rb:151:in `each' /opt/figgy/shared/bundle/ruby/2.4.0/gems/sequel_pg-1.11.0/lib/sequel_pg/sequel_pg.rb:81:in `each' /opt/figgy/releases/20181112195325/app/services/reindexer.rb:28:in `each' /opt/figgy/releases/20181112195325/app/services/reindexer.rb:28:in `each' /opt/figgy/releases/20181112195325/app/services/reindexer.rb:28:in `each' /opt/figgy/releases/20181112195325/app/services/reindexer.rb:28:in `each_slice' /opt/figgy/releases/20181112195325/app/services/reindexer.rb:28:in `reindex_all' /opt/figgy/releases/20181112195325/app/services/reindexer.rb:10:in `reindex_all' /opt/figgy/releases/20181112195325/lib/tasks/reindex.rake:8:in `block in <top (required)>' /opt/figgy/shared/bundle/ruby/2.4.0/gems/rake-12.3.1/exe/rake:27:in `<top (required)>' Tasks: TOP => reindex (See full trace by running task with --trace)